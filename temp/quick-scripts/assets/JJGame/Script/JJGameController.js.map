{"version":3,"sources":["JJGameController.js"],"names":["cc","Class","extends","Component","properties","mapLayer","default","type","Node","uiLayer","onLoad","Atom","gameState","setGameStop","eventMgr","listen","obj","data","onStartGame","onGameOver","onPause","onReStart","start","addTouchEvent","onDestroy","unListenByObj","console","log","gameUpdateInterval","gameConfMgr","getInfo","gameSpeed","maxSteps","indexOffset","gameDataMgr","setData","topbar","prefabMgr","getPrefabObj","parent","topbar_delegate","getComponent","addBrick","playReadGo","setGameStart","controltips","controltips_delegate","self","node","on","EventType","TOUCH_START","event","isGameIng","posi","touch","_point","width","getData","brickNum","turnSpeed","minx","maxx","action","x","player","moveTo","p","y","runAction","TOUCH_MOVE","TOUCH_END","TOUCH_CANCEL","stopAllActions","_type","over_ui","zIndex","removeAllChildren","removeFromParent","_bool","pause_ui","setGamePause","setGameIng","indexTag","player_indexTag","minterval","mapController","i","bricklist","makeBrickNodes","j","length","height","name","Math","ceil","update","dt","mapUpdate","score","notify","mUpdate","isGameStart"],"mappings":"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","file":"JJGameController.js","sourceRoot":"../../../../../assets/JJGame/Script","sourcesContent":["\ncc.Class({\n    extends: cc.Component,\n\n    properties: {\n        //地图层\n        mapLayer:{\n            default:null,\n            type:cc.Node,\n        },\n        uiLayer:{\n            default:null,\n            type:cc.Node,\n        },\n    },\n\n    onLoad () {\n        cc.Atom.gameState.setGameStop();\n        cc.Atom.eventMgr.listen(\"onStartGame\", (obj,data)=>{ this.onStartGame()     }, this);\n        cc.Atom.eventMgr.listen(\"onGameOver\" , (obj,data)=>{ this.onGameOver(data)  }, this);\n        cc.Atom.eventMgr.listen(\"onPause\"    , (obj,data)=>{ this.onPause(data)     }, this);\n        cc.Atom.eventMgr.listen(\"onReStart\"  , (obj,data)=>{ this.onReStart(data)   }, this);\n    },\n\n    start () {    \n        this.addTouchEvent()\n    },\n\n    onDestroy(){\n        cc.Atom.eventMgr.unListenByObj(this)\n    },\n\n    onStartGame(){\n        console.log(\">>>> onStartGame \")\n        this.gameUpdateInterval = cc.Atom.gameConfMgr.getInfo(\"gameUpdateInterval\");\n        this.gameSpeed = cc.Atom.gameConfMgr.getInfo(\"gameSpeed\"); //节奏提速\n        this.maxSteps = cc.Atom.gameConfMgr.getInfo(\"maxSteps\");   //最大层数\n        this.indexOffset = cc.Atom.gameConfMgr.getInfo(\"indexOffset\");//阶的偏移index\n\n        cc.Atom.gameDataMgr.setData(\"mSaveStart\",0)\n        //add top bar\n        var topbar = cc.Atom.prefabMgr.getPrefabObj(\"topStatuBar\");\n        topbar.parent = this.uiLayer;\n        this.topbar = topbar;\n        this.topbar_delegate = this.topbar.getComponent(\"topBarDelegate\")\n\n        this.addBrick();\n        //play ready go\n        this.playReadGo();\n        cc.Atom.gameState.setGameStart()\n    },\n\n    playReadGo(){\n        var controltips = cc.Atom.prefabMgr.getPrefabObj(\"controltips\");\n        controltips.parent = this.uiLayer;\n        this.controltips = controltips;\n        this.controltips_delegate = this.controltips.getComponent(\"controltipsDelegate\")\n    },\n\n    addTouchEvent(){\n        var self = this\n        this.node.on(cc.Node.EventType.TOUCH_START, function (event) {\n            console.log(\">>>>>> TOUCH_START\");\n            if(!cc.Atom.gameState.isGameIng()){\n                return\n            }\n\n            var posi = event.touch._point\n            //边界\n            var width = cc.Atom.gameDataMgr.getData(\"brickWidth\");\n            var brickNum = cc.Atom.gameConfMgr.getInfo(\"brickNum\");\n            var turnSpeed  = cc.Atom.gameConfMgr.getInfo(\"turnSpeed\");\n            var minx = (1 - ( brickNum +1) /2) * width;\n            var maxx = (brickNum - ( brickNum +1) /2) * width;\n\n            var action;\n            if(posi.x < self.node.width /2){\n                var x = self.player.x -width;\n                if(x < minx){\n                    x = minx;\n                }\n                action = cc.moveTo(turnSpeed, cc.p(x , self.player.y));\n            }else{\n                var x = self.player.x +width;\n                if(x > maxx){\n                    x = maxx;\n                }\n                action = cc.moveTo(turnSpeed, cc.p(x , self.player.y));\n            }\n            self.player.runAction(action);\n        })\n\n        this.node.on(cc.Node.EventType.TOUCH_MOVE, function (event) {\n            console.log(\">>>>>> TOUCH_MOVE\");\n        })\n\n        this.node.on(cc.Node.EventType.TOUCH_END, function (event) {\n            console.log(\">>>>>> TOUCH_END\");\n        })\n\n        this.node.on(cc.Node.EventType.TOUCH_CANCEL, function (event) {\n            console.log(\">>>>>> TOUCH_CANCEL\");\n        })\n    },\n\n    onGameOver(data){\n        this.player.stopAllActions();\n        //\n        console.log(\">>> player over\");\n        if(data){\n            var _type = data._type\n\n        }\n        var over_ui = cc.Atom.prefabMgr.getPrefabObj(\"over_ui\");\n        over_ui.parent = this.uiLayer\n        over_ui.zIndex = 150\n    },\n\n    onReStart(){\n        cc.Atom.gameState.setGameStop()\n        this.mapLayer.removeAllChildren()\n        this.topbar.removeFromParent()\n        this.onStartGame();\n    },\n\n    onPause(_bool){\n        if(_bool == true){\n            console.log(\">>> show pause_ui \")\n            var pause_ui = cc.Atom.prefabMgr.getPrefabObj(\"paruse_ui\");\n            pause_ui.parent = this.uiLayer\n            pause_ui.zIndex = 150\n            cc.Atom.gameState.setGamePause()\n        }else{\n            cc.Atom.gameState.setGameIng()\n        }\n        \n    },\n\n    addBrick(){\n        this.indexTag = 0; //砖块的位置\n        this.player_indexTag = 0;\n        this.minterval = 0;\n\n        this.mapController = this.mapLayer.getComponent('MapController');\n        //创建基础地图\n        for (var i = 1; i <= this.maxSteps/this.indexOffset; i++) {\n            var bricklist = this.mapController.makeBrickNodes(i)\n            for (var j = 0; j < bricklist.length; j++) {\n                var node = bricklist[j];\n                if(node){\n                    var width  = node.width;\n                    var height = node.height;\n                    var x = (j+1 - ( bricklist.length +1) /2) * width ;\n                    var y = i  * height - height/2;\n                    node.parent = this.mapLayer;\n                    node.x = x;\n                    node.y = y;\n\n                    cc.Atom.gameDataMgr.setData(\"brickWidth\" , width)\n                    cc.Atom.gameDataMgr.setData(\"brickHeight\", height)\n                }\n            }\n        }\n\n        //添加obj\n        var player = cc.Atom.prefabMgr.getPrefabObj(\"player_obj\"); //创建一个砖块 prefab节点\n        player.name   = \"player\"; \n        player.parent = this.mapLayer;\n        player.y = player.height/2 + player.height*3;\n        player.zIndex  = 100\n        this.player = player;\n\n        this.player_indexTag = Math.ceil(cc.Atom.gameConfMgr.getInfo(\"brickNum\")/2);\n        cc.Atom.gameDataMgr.setData(\"isPlayerMove\" , true);\n    },\n\n    update (dt) {\n        if(cc.Atom.gameState.isGameIng()){\n            this.mapController.mapUpdate(this.mapLayer , dt);\n            var score = dt *100\n            cc.Atom.eventMgr.notify(\"onAddScore\" , score);\n\n            this.topbar_delegate.mUpdate(dt);\n        }else if(cc.Atom.gameState.isGameStart()){\n            this.controltips_delegate.mUpdate(dt);\n        }\n    },\n});\n"]}