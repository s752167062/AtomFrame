{"version":3,"sources":["MapController.js"],"names":["cc","Class","extends","Component","properties","TAG","ctor","console","log","onLoad","onDestroy","makeBrick","brickNum","Atom","gameConfMgr","getInfo","bricList","i","item","brickType","aiBrickType","mSaveStart","gameDataMgr","getData","setData","ran","Math","round","random","saveStart","BRICKS","TRAP","BUFF","BASE","makeBrickNodes","index_tag","bricList_data","brickNodeList","length","node","prefabMgr","getPrefabObj","name","zIndex","brickScript","getComponent","setBrickData","mapUpdate","target","dt","makeNew","position_max","move","player","getChildByName","y","brick","height","bricks","getChildren","m","removeFromParent","nbricks","px","x","py","hitOffset","bi","abs","width","script","_type","getBrickData","gameState","setGameOver","eventMgr","notify","onBuff","nodelist","j","parent"],"mappings":"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","file":"MapController.js","sourceRoot":"../../../../../assets/JJGame/Script","sourcesContent":["//MapController 只负责数据的生成，不包含节点\n/*\n    1.地图初始生成 后续在生成点添加新的点\n    2.地图向下移动，出地图的部分自动删除\n*/\ncc.Class({\n    extends: cc.Component,\n\n    properties: {\n        TAG: \"MapController\"\n    },\n\n    ctor() {\n        console.log(\"-new:\" + this.TAG);\n    },\n\n    onLoad(){\n        console.log(\"-load:\" + this.TAG);\n    },\n\n    onDestroy(){\n        console.log(\"-destory:\" + this.TAG);\n    },\n\n    //生成砖块数据\n    makeBrick(){\n        var brickNum = cc.Atom.gameConfMgr.getInfo(\"brickNum\");\n        var bricList = [];\n        for (var i = 0; i < brickNum; i++) {\n            var item = {};\n            item.brickType= this.aiBrickType(); \n            item.brickNum = brickNum;//本阶的砖块数量\n            bricList[i] = item;\n        }\n        var mSaveStart = cc.Atom.gameDataMgr.getData(\"mSaveStart\");\n        cc.Atom.gameDataMgr.setData(\"mSaveStart\" , mSaveStart + 1);\n        return bricList;\n    },\n    aiBrickType(){\n        //ai 运算是什么类型  base , empy , trap , buff\n        var ran = Math.round(Math.random()*100)\n        var mSaveStart = cc.Atom.gameDataMgr.getData(\"mSaveStart\");\n        var saveStart  = cc.Atom.gameConfMgr.getInfo(\"saveStart\") ; //过了安全区才可以创建特殊砖块\n        console.log(\">>>>>>> aiBrickType ran %d\" , ran)\n        if( ran < 20 && mSaveStart > saveStart){\n            return  cc.Atom.gameConfMgr.BRICKS.TRAP ;//\"trap\";\n        }else if(ran < 22 && mSaveStart > saveStart){\n            return  cc.Atom.gameConfMgr.BRICKS.BUFF ;//buff;\n        }\n        return cc.Atom.gameConfMgr.BRICKS.BASE; //\"base\";\n    },\n\n    //生成位置节点\n    //index_tag 新一行的起始tag  （循环的 1-50 ）\n    makeBrickNodes(index_tag){\n        var bricList_data = this.makeBrick();\n        var brickNodeList = [];\n        for (var i = 0; i < bricList_data.length; i++) {\n            var item = bricList_data[i];\n            var node = cc.Atom.prefabMgr.getPrefabObj(\"brick\"); //创建一个砖块 prefab节点\n            //预设对象才处理\n            console.log(\">>> prefab obj type :\" + typeof(node))\n            if(node != null){\n                node.name = (item.brickType == cc.Atom.gameConfMgr.BRICKS.BASE ) ? \"brick\": \"component_brick\" ; //\"\" + (index_tag + i);\n                node.zIndex = 50\n                //获取预制资源中的js组件，并作出相应操作\n                var brickScript = node.getComponent('BrickDelegate');\n                brickScript.setBrickData(item);\n                brickNodeList[i] = node;\n            }else{\n                console.log(\">>>> ERR makeBrickNodes node not a prefab object !!!\")\n            }\n\n        } \n        return brickNodeList;\n    },\n\n    //地图移动\n    //target 地图层\n    mapUpdate(target ,dt){\n        var makeNew = false;\n        var position_max = 0;   \n        var move = cc.Atom.gameConfMgr.getInfo(\"gameUpdateMove\") * dt;\n        var player = target.getChildByName(\"player\")\n        if(cc.Atom.gameDataMgr.getData(\"isPlayerMove\") == true){\n            //移动角色\n            if(player){\n                player.y = player.y + move\n\n                var brick  = target.getChildByName(\"brick\")\n                var height = brick.height \n                if(player.y >= height * 3 ){\n                    player.y = height * 3 + height/2\n                    cc.Atom.gameDataMgr.setData(\"isPlayerMove\", false)\n                }\n            }\n        }else{\n            //移动砖块\n            var bricks = target.getChildren();\n            console.log(\">>>> map brick number : %d\" , bricks.length)\n            for (var i = 0; i < bricks.length; i++) {\n                var item = bricks[i];\n                if(item.name == \"brick\" || item.name == \"component_brick\"){\n                    item.y = item.y - move;\n                }\n            }\n        \n            for (var m = bricks.length -1; m >=0 ; m--){\n                var node = bricks[m];\n                if(node.name == \"brick\" || node.name == \"component_brick\"){\n                    if(node.y < -node.height/2){//节点出了界面了 删除掉\n                        makeNew = true;\n                        node.removeFromParent();\n                    }\n\n                    if(node.y > position_max){\n                        position_max = node.y;\n                    }\n                }\n            }\n        }\n\n        \n\n        //碰撞检测\n        var nbricks = target.getChildren();\n        var px = player.x\n        var py = player.y\n        var hitOffset = cc.Atom.gameConfMgr.getInfo(\"hitOffset\");//碰撞允许的偏移量\n        for (var bi = 0; bi < nbricks.length; bi++) {\n            var item = nbricks[bi];\n            if(item.name == \"component_brick\"){\n                if(Math.abs(item.x - px) < item.width - hitOffset && Math.abs(item.y -py) < item.height - hitOffset){\n                    console.log(\">>>> player hit\")\n                    var script = item.getComponent(\"BrickDelegate\");\n                    var _type = script.getBrickData().brickType;\n                    if(_type == cc.Atom.gameConfMgr.BRICKS.TRAP ){\n                        console.log(\">>>> over\")\n                        cc.Atom.gameState.setGameOver();\n                        cc.Atom.eventMgr.notify(\"onGameOver\",{ _type: _type})\n                    }else if(_type == cc.Atom.gameConfMgr.BRICKS.BUFF){\n                        console.log(\">>>> buff\")\n                        script.onBuff()\n                        cc.Atom.eventMgr.notify(\"onBuffEnergy\")\n                    }\n                }\n            }\n        }\n\n        if (makeNew == true) {\n            //补上新的一行节点\n            var nodelist = this.makeBrickNodes();\n            for (var j = 0; j < nodelist.length; j++) {\n                var brick = nodelist[j];\n                if(brick){\n                    var width  = brick.width;\n                    var height = brick.height;\n                    var x = (j+1 - ( nodelist.length +1) /2) * width ;\n                    var y = position_max + height;\n                    brick.parent = target;\n                    brick.x = x;\n                    brick.y = y;\n                }\n            }\n        }\n    }\n\n});\n"]}